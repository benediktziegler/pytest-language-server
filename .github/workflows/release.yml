name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: [x86_64, x86, aarch64, armv7, s390x, ppc64le]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
          allow-prereleases: true
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter python3.10 python3.11 python3.12 python3.13 python3.14 python3.14t pypy3.10 pypy3.11
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  musllinux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: [x86_64, x86, aarch64, armv7]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
          allow-prereleases: true
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter python3.10 python3.11 python3.12 python3.13 python3.14 python3.14t pypy3.10 pypy3.11
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: musllinux_1_2
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-musllinux-${{ matrix.target }}
          path: dist

  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x64, x86]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: |
            3.10
            3.11
            3.12
            3.13
            3.14
          architecture: ${{ matrix.target }}
          allow-prereleases: true
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter 3.10 3.11 3.12 3.13 3.14
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  windows-freethreaded:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x64, x86]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: '3.14t'
          architecture: ${{ matrix.target }}
          allow-prereleases: true
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter 3.14t
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-windows-${{ matrix.target }}-freethreaded
          path: dist

  macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-13
            target: x86_64
          - runner: macos-14
            target: aarch64
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
          allow-prereleases: true
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter 3.10 3.11 3.12 3.13 3.14 3.14t pypy3.10 pypy3.11
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v5
        with:
          name: wheels-sdist
          path: dist

  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [linux, musllinux, windows, windows-freethreaded, macos, sdist]
    permissions:
      id-token: write
      contents: write
      attestations: write
    steps:
      - uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: wheels-*
          path: wheels

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "wheels/*/*.whl"

      - name: Flatten wheels directory
        run: |
          mkdir -p dist
          find wheels -name "*.whl" -exec cp {} dist/ \;
          find wheels -name "*.tar.gz" -exec cp {} dist/ \;
          ls -lh dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          fail_on_unmatched_files: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  build-binaries:
    name: Build standalone binaries for extensions
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: pytest-language-server-x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary_name: pytest-language-server-aarch64-unknown-linux-gnu
          - os: macos-13
            target: x86_64-apple-darwin
            binary_name: pytest-language-server-x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
            binary_name: pytest-language-server-aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: pytest-language-server.exe
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build binary
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cargo build --release --target ${{ matrix.target }}
      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mv target/${{ matrix.target }}/release/pytest-language-server target/${{ matrix.target }}/release/${{ matrix.binary_name }}
      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          move target\${{ matrix.target }}\release\pytest-language-server.exe target\${{ matrix.target }}\release\${{ matrix.binary_name }}
      - name: Upload binary
        uses: actions/upload-artifact@v5
        with:
          name: binary-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.binary_name }}

  publish-vscode:
    name: Publish VSCode extension
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-binaries]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Download all binaries
        uses: actions/download-artifact@v6
        with:
          pattern: binary-*
          path: extensions/vscode-extension/bin
      - name: Flatten binaries
        run: |
          cd extensions/vscode-extension/bin
          find . -type f -name "pytest-language-server*" -exec mv {} . \;
          find . -type d -empty -delete
          chmod +x pytest-language-server-* || true
          ls -lh
      - name: Install dependencies
        run: |
          cd vscode-extension
          npm install
          npm install -g @vscode/vsce
      - name: Package extension
        run: |
          cd vscode-extension
          vsce package
      - name: Publish to VSCode Marketplace
        run: |
          cd vscode-extension
          vsce publish -p ${{ secrets.VSCE_TOKEN }}

  publish-intellij:
    name: Publish IntelliJ/PyCharm plugin
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-binaries]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Download all binaries
        uses: actions/download-artifact@v6
        with:
          pattern: binary-*
          path: extensions/intellij-plugin/src/main/resources/bin
      - name: Flatten binaries
        run: |
          cd extensions/intellij-plugin/src/main/resources/bin
          find . -type f -name "pytest-language-server*" -exec mv {} . \;
          find . -type d -empty -delete
          chmod +x pytest-language-server-* || true
          ls -lh
      - name: Build plugin
        run: |
          cd extensions/intellij-plugin
          chmod +x build.sh
          ./build.sh
      - name: Upload plugin to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: extensions/intellij-plugin/dist/pytest-language-server-*.zip
      - name: Publish to JetBrains Marketplace
        run: |
          # Install plugin-verifier and marketplace tools
          curl -L https://github.com/JetBrains/intellij-plugin-verifier/releases/download/1.307/plugin-verifier-1.307-all.jar -o plugin-verifier.jar
          # For now, just upload to GitHub releases
          # Manual JetBrains publishing requires their CLI tool or web upload
          echo "Plugin built and uploaded to GitHub releases"
          echo "Upload manually to https://plugins.jetbrains.com/plugin/add"

  publish-zed:
    name: Publish Zed extension
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-binaries]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
      - name: Download all binaries
        uses: actions/download-artifact@v6
        with:
          pattern: binary-*
          path: extensions/zed-extension/bin
      - name: Flatten binaries
        run: |
          cd extensions/zed-extension/bin
          find . -type f -name "pytest-language-server*" -exec mv {} . \;
          find . -type d -empty -delete
          chmod +x pytest-language-server-* || true
          ls -lh
      - name: Build Zed extension
        run: |
          cd zed-extension
          cargo build --release --target wasm32-wasip1
      - name: Package extension
        run: |
          cd zed-extension
          mkdir -p dist
          cp target/wasm32-wasip1/release/pytest_language_server.wasm dist/extension.wasm
          cp -r bin dist/
          cp extension.toml dist/
      - name: Publish to Zed Extensions
        run: |
          cd zed-extension
          # Note: Zed extension publishing requires manual submission or API key
          # For now, just upload the packaged extension to GitHub releases
          tar -czf ../pytest-language-server-zed-extension.tar.gz -C dist .
      - name: Upload Zed extension to release
        uses: softprops/action-gh-release@v2
        with:
          files: pytest-language-server-zed-extension.tar.gz
